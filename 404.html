<!DOCTYPE html>
<html>

<head>
    <title>Club Experience Scheduler</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">


    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="col-lg-12">
            <p id="loading" class="hideable">Loading...</p>

            <div id="main" class="hideable hidden">
                <h1>Register for: <span class="event-name">loading...</span></h1>
                <p class="text-muted">You are registering as <span class="token-owner-name"></span>.</p>
                <p id="already-registered" class="hidden"><b>You have already registered for this event. You can change your choice below.</b></p>
                <hr>
                <p class="event-description"></p>
                <br>
                <p><b>More Information:</b></p>
                <p class="hidden" id="no-info">No additional information was found associated with the event.</p>
                <table class="table table-hover" id="info-table">
                    <tbody id="info-body"></tbody>
                </table>
                <br>
                <button id="attend-full" class="form-control btn-success">I can attend all of the event.</button>
                <br>
                <button id="attend-part" class="form-control btn-primary">I can attend part of the event.</button>
                <br>
                <button id="attend-none" class="form-control btn-danger">I can attend none of the event.</button>

            </div>
            <div id="confirm" class="hideable hidden">
                <h1>Are you sure?</h1>
                <p>You are confirming that you can attend <span id="portion"></span> of the event.</p>
                <br>
                <button class="btn-primary form-control" id="confirm-cancel-button">No, Go back</button>
                <hr>
                <button class="btn-danger form-control" id="confirm-confirm-button">Yes, I am sure</button>

            </div>
            <div id="error404" class="hideable hidden">
                <h1>404 Error: page not found</h1>
                <p>The requested page was not found.<br><a href="/scheduler/">Click here to go to the home page.</a></p>
            </div>
            <div id="error" class="hideable hidden">
                <h1>Unknown Error Occured</h1>
                <p>Please try again<br><a class="show-main">Click here to go back.</a></p>
            </div>
            <div id="reserved" class="hideable hidden">
                <h1>Success! You have confirmed you can attend <span id="reserved-portion"></span></h1>
                <p>Your confirmation has been recorded.<br><a class="show-main">Edit your response.</a></p>
            </div>

        </div>
    </div>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/3.6.1/firebase.js"></script>
    <script>
        /* global firebase */
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyDSCVcPcMzCXMjGhQvQJfkgnjCFzzewTgA",
            authDomain: "jmeng.firebaseapp.com",
            databaseURL: "https://jmeng.firebaseio.com",
            storageBucket: "project-4679594405675385181.appspot.com",
            messagingSenderId: "590199481216"
        };
        firebase.initializeApp(config);
    </script>
    <script>
        /* global firebase $ */
        $(".show-main").click(function() {
            $("#error").addClass("hidden");
            $(".hideable").addClass("hidden");
            $("#main").removeClass("hidden");
        });

        function confirm(portion, tokenName, token) {
            console.log(tokenName);
            firebase.database().ref("cescheduler/" + tokenName + "/confirmations/" + token + "/").set({
                name: token.name,
                token: tokenName,
                status: portion
            }).then(function() {
                $("#loading").addClass("hidden");
                if (portion === "full") {
                    $("#reserved-portion").html("all");
                }
                else {
                    $("#reserved-portion").html(portion);
                }

                $("#reserved").removeClass("hidden");
            }).catch(function() {
                $("#loading").addClass("hidden");
                $("#error").removeClass("hidden");
            });
        }

        function showConfirm(portion, tokenName, token) {
            $("#main").addClass("hidden");
            $("#confirm").removeClass("hidden");
            $("#confirm-cancel-button").click(function() {
                $("#confirm").addClass("hidden");
                $("#main").removeClass("hidden");
            });
            $("#confirm-confirm-button").click(function() {
                confirm(portion, tokenName, token);
                $("#confirm").addClass("hidden");
                $("#loading").removeClass("hidden");

            });

        }
        var page = window.location.pathname.substring(1).split("/");
        console.log(page);


        if (page[0] === "event" && page[1] !== null && page[1] !== undefined && page[1] !== "" && page.length >= 2) {
            console.log(1);
            if (page[1].match(/[\/\[\]\\\{\}]\#$/g) || page[2].match(/[\/\[\]\\\{\}]\#$/g)) {
                console.log(false);
                $("#loading").addClass("hidden");
                $("#error404").removeClass("hidden");
            }
            else {
                console.log(2);
                firebase.database().ref("cescheduler/" + page[1] + "/").once('value').then(function(snapshot) {
                    var data = snapshot.val();
                    if (data === null) {
                        $("#loading").addClass("hidden");
                        $("#error404").removeClass("hidden");
                    }
                    else if (!data.open) {
                        $("#loading").addClass("hidden");
                        $("#closed").removeClass("hidden");
                    }
                    else if (data.tokens[page[2]]) {
                        console.log(data);
                        $(".event-name").html(data.name);
                        $(".event-description").html(data.description);
                        $(".token-owner-name").html(data.tokens[page[2]].name);
                        console.log(!!data.tokens[page[2]].registered);
                        if (!!data.tokens[page[2]].registered) {
                            $("#already-registered").removeClass("hidden");
                        }
                        var info = data.info;
                        if (info === null) {
                            $("#info-table").addClass("hidden");
                            $("#no-info").removeClass("hidden");
                        }
                        else {
                            for (var key in info) {
                                //property is from prototype
                                if (!info.hasOwnProperty(key)) continue;

                                var element = info[key];
                                $("#info-body").append("<tr><td>" + key + "</td><td>" + element + "</td></tr>");
                            }
                        }


                        $("#attend-full").click(function() {
                            showConfirm("full", page[2], data.tokens[page[2]]);
                        });
                        $("#attend-part").click(function() {
                            showConfirm("part", page[2], data.tokens[page[2]]);
                        });
                        $("#attend-none").click(function() {
                            showConfirm("none", page[2], data.tokens[page[2]]);
                        });
                        $("#loading").addClass("hidden");
                        $("#main").removeClass("hidden");

                    }
                    else {
                        $("#loading").addClass("hidden");
                        $("#error404").removeClass("hidden");
                    }
                });
            }
        }
        else {
            console.log(21);
            $("#loading").addClass("hidden");
            $("#error404").removeClass("hidden");
        }
    </script>
</body>

</html>
